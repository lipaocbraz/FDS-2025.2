{% extends "app1/html/base.html" %}
{% block content %}

<h2 style="text-align:center; margin-bottom:30px;color:white;">
  Análise do Saldo Mensal (Final do Mês) - Ano {{ ano }}
</h2>

<div class="grid-container">
  <!-- 1º gráfico: Positivo vs Negativo -->
  <div class="chart-card">
    <canvas id="saldoChart1"></canvas>
  </div>

  <!-- 2º gráfico: Saldo Líquido -->
  <div class="chart-card">
    <canvas id="saldoChart2"></canvas>
  </div>

  <!-- 3º gráfico: Entradas vs Saídas -->
  <div class="chart-card">
    <canvas id="saldoChart3"></canvas>
  </div>

  <!-- 4º gráfico: Saídas por Categoria -->
  <div class="chart-card">
    <canvas id="saldoChart4"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const options = {
    responsive: true,
    plugins: {
      legend: { position: 'top' },
    },
    scales: { y: { beginAtZero: true } }
  };

  // 1º gráfico - Positivo vs Negativo
  const dataPosNeg = {
    labels: {{ meses_rotulos|safe }},
    datasets: [
      { label: 'Positivo', data: {{ saldo_positivo|safe }}, backgroundColor: 'green' },
      { label: 'Negativo', data: {{ saldo_negativo|safe }}, backgroundColor: 'red' }
    ]
  };
  new Chart(document.getElementById('saldoChart1'), { 
    type: 'bar', 
    data: dataPosNeg, 
    options: { ...options, plugins: { title: { display:true, text:'Saldo Mensal (Positivo vs Negativo)' } } }
  });

  // 2º gráfico - Saldo Líquido
  const dataLiquido = {
    labels: {{ meses_rotulos|safe }},
    datasets: [
      { 
        label: 'Saldo Líquido', 
        data: {{ saldo_liquido|safe }},
        backgroundColor: {{ saldo_liquido|safe }}.map(v => v >= 0 ? 'green' : 'red')
      }
    ]
  };
  new Chart(document.getElementById('saldoChart2'), { 
    type: 'bar', 
    data: dataLiquido, 
    options: { ...options, plugins: { title: { display:true, text:'Saldo Mensal (Líquido)' } } }
  });

  // 3º gráfico - Entradas vs Saídas do mês atual
  const dataEntradasSaidas = {
    labels: ['Entradas', 'Saídas'],
    datasets: [
      {
        label: `Entradas e Saídas - {{ mes }}/{{ ano }}`,
        data: [{{ entradas }}, {{ saidas }}],
        backgroundColor: ['green', 'red'],
      }
    ]
  };
  new Chart(document.getElementById('saldoChart3'), { 
    type: 'bar',
    data: dataEntradasSaidas,
    options: { 
      ...options,
      plugins: { title: { display:true, text:'Entradas e Saídas (Mês Atual)' }, legend: { display:false } }
    }
  });

  // 4º gráfico - Saídas por Categoria
  const categorias = [
    {% for item in saidas_por_categoria %}
      "{{ item.descricao }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const valores = [
    {% for item in saidas_por_categoria %}
      {{ item.total }}{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const dataSaidasCategoria = {
    labels: categorias,
    datasets: [
      {
        label: `Saídas por Categoria - {{ mes }}/{{ ano }}`,
        data: valores,
        backgroundColor: 'red'
      }
    ]
  };

  new Chart(document.getElementById('saldoChart4'), {
    type: 'bar',
    data: dataSaidasCategoria,
    options: { 
      responsive: true,
      plugins: { title: { display:true, text:'Saídas por Categoria' }, legend: { display:false } },
      scales: { y: { beginAtZero: true } }
    }
  });

</script>

<style>
  .grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 20px;
    width: 95%;
    margin: auto;
    height: 85vh;
  }

  .chart-card {
    background: #e0e0e0;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    max-width: 100% !important;
    max-height: 100% !important;
  }
</style>

{% endblock content %}
